<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoGuesser</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        #header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            position: relative;
            z-index: 1001;
        }

        #header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        #current-question {
            font-size: 1.3em;
            font-weight: bold;
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 8px;
            display: inline-block;
            margin-top: 10px;
        }

        #stats {
            margin-top: 15px;
            font-size: 0.95em;
        }

        #map {
            height: calc(100vh - 180px);
            width: 100%;
        }

        #buttons {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            z-index: 1000;
        }

        .btn {
            padding: 12px 30px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        #next-btn {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        #show-answer-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        /* è‡ªå®šä¹‰æ ‡è®°æ ·å¼ */
        .city-marker {
            background: white;
            border: 3px solid #333;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .city-marker:hover {
            transform: scale(1.3);
            border-color: #667eea;
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.6);
        }

        /* æ­£ç¡®ç­”æ¡ˆæ ‡è®° */
        .correct-marker {
            background: #4CAF50;
            border-color: #2E7D32;
            width: 25px;
            height: 25px;
            animation: pulse 0.5s ease;
        }

        /* é”™è¯¯ç­”æ¡ˆæ ‡è®° */
        .wrong-marker {
            background: #f44336;
            border-color: #c62828;
            width: 25px;
            height: 25px;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.5); }
            100% { transform: scale(1); }
        }

        /* Popupæ ·å¼ */
        .leaflet-popup-content-wrapper {
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .leaflet-popup-content {
            font-size: 14px;
            line-height: 1.6;
            max-width: 300px;
        }

        .info-popup h3 {
            color: #667eea;
            margin-bottom: 8px;
            font-size: 18px;
        }

        .info-popup p {
            color: #555;
            text-align: justify;
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>GeoGuesser</h1>
        <div id="current-question">å‡†å¤‡å¼€å§‹...</div>
        <div id="stats">
            å¾—åˆ†: <span id="score">0</span> / <span id="total">0</span>
        </div>
    </div>
    <div id="map"></div>
    <div id="buttons">
        <button class="btn" id="show-answer-btn">æ˜¾ç¤ºç­”æ¡ˆ</button>
        <button class="btn" id="next-btn">ä¸‹ä¸€é¢˜</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // å…¨å±€å˜é‡
        let map;
        let cities = [];
        let cityMarkers = {};
        let currentCityIndex = -1;
        let currentQuestionCity = null;
        let correctMarker = null;
        let score = 0;
        let totalQuestions = 0;
        let questionAnswered = false;
        let wrongAttempts = 0;
        const maxWrongAttempts = 3;

        // åˆå§‹åŒ–åœ°å›¾
        function initMap() {
            map = L.map('map').setView([20, 0], 2);

            var CartoDB_VoyagerNoLabels = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 20
            });

            CartoDB_VoyagerNoLabels.addTo(map);

            // åŠ è½½åŸå¸‚æ•°æ®
            loadCities();
        }

        // åŠ è½½åŸå¸‚æ•°æ®
        function loadCities() {
            fetch('data/cities.csv')
                .then(response => response.text())
                .then(data => {
                    parseCities(data);
                    addCityMarkers();
                    showCityMarkers();
                    startNewQuestion();
                })
                .catch(error => {
                    console.error('åŠ è½½åŸå¸‚æ•°æ®å¤±è´¥:', error);
                    document.getElementById('current-question').textContent = 'åŠ è½½åŸå¸‚æ•°æ®å¤±è´¥';
                });
        }

        // è§£æCSVæ•°æ®
        function parseCities(csvData) {
            const lines = csvData.trim().split('\n');
            const headers = lines[0].split(',');

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                
                // å¤„ç†åŒ…å«å¼•å·çš„infoå­—æ®µ
                let info = '';
                if (values.length > 4) {
                    // å¦‚æœinfoå­—æ®µåŒ…å«é€—å·ï¼Œåˆå¹¶å‰©ä½™éƒ¨åˆ†
                    const infoParts = values.slice(4);
                    info = infoParts.join(',').trim();
                    // å»é™¤å¯èƒ½çš„å¼•å·
                    if (info.startsWith('"') && info.endsWith('"')) {
                        info = info.slice(1, -1);
                    }
                }

                cities.push({
                    country: values[0].trim(),
                    city: values[1].trim(),
                    lat: parseFloat(values[2]),
                    lon: parseFloat(values[3]),
                    info: info
                });
            }
            
            console.log(`åŠ è½½äº† ${cities.length} ä¸ªåŸå¸‚`);
        }

        // æ·»åŠ æ‰€æœ‰åŸå¸‚æ ‡è®°
        function addCityMarkers() {
            cities.forEach((city, index) => {
                const icon = L.divIcon({
                    className: 'city-marker',
                    iconSize: [15, 15],
                    iconAnchor: [10, 10]
                });

                const marker = L.marker([city.lat, city.lon], { icon: icon })
                    .on('click', function() {
                        handleCityClick(index);
                    });

                // å¦‚æœæœ‰infoä¿¡æ¯ï¼Œæ·»åŠ popup
                if (city.info) {
                    marker.bindPopup(`
                        <div class="info-popup">
                            <h3>${city.city}</h3>
                            <p>${city.info}</p>
                        </div>
                    `, {
                        maxWidth: 350
                    });
                } else {
                    marker.bindPopup(`
                        <div class="info-popup">
                            <h3>${city.city}</h3>
                            <p>ä½äº${city.country}</p>
                        </div>
                    `, {
                        maxWidth: 350
                    });
                }

                cityMarkers[index] = marker;
            });
        }

        // æ˜¾ç¤ºæ‰€æœ‰åŸå¸‚æ ‡è®°
        function showCityMarkers() {
            cities.forEach((city, index) => {
                if (cityMarkers[index] && !map.hasLayer(cityMarkers[index])) {
                    cityMarkers[index].addTo(map);
                }
            });
        }

        // å¼€å§‹æ–°é—®é¢˜
        function startNewQuestion() {
            // é‡ç½®çŠ¶æ€
            questionAnswered = false;
            wrongAttempts = 0;
            if (correctMarker) {
                correctMarker = null;
            }

            // å…ˆéšè—æ‰€æœ‰æ ‡è®°
            cities.forEach((city, index) => {
                if (cityMarkers[index] && map.hasLayer(cityMarkers[index])) {
                    map.removeLayer(cityMarkers[index]);
                }
                // é‡ç½®æ ‡è®°æ ·å¼
                const icon = L.divIcon({
                    className: 'city-marker',
                    iconSize: [15, 15],
                    iconAnchor: [10, 10]
                });
                cityMarkers[index].setIcon(icon);
            });

            // éšæœºé€‰æ‹©ä¸€ä¸ªåŸå¸‚ä½œä¸ºé—®é¢˜
            currentCityIndex = Math.floor(Math.random() * cities.length);
            currentQuestionCity = cities[currentCityIndex];

            // æ˜¾ç¤ºé—®é¢˜
            document.getElementById('current-question').textContent = 
                `è¯·åœ¨åœ°å›¾ä¸Šæ‰¾åˆ°: ${currentQuestionCity.country} ${currentQuestionCity.city}`;

            // å°†åœ°å›¾è§†å›¾ç§»åŠ¨åˆ°è¯¥åŸå¸‚é™„è¿‘ï¼ˆä½†ä¸æ˜¾ç¤ºæ ‡è®°ï¼‰
            const targetCity = cities[currentCityIndex];
            // æ·»åŠ éšæœºåç§»é‡ï¼Œé˜²æ­¢ç›´æ¥çŒœåˆ°
            const randomOffset = 5 + Math.random() * 5; // 5-10åº¦çš„éšæœºåç§»
            const randomAngle = Math.random() * Math.PI * 2; // éšæœºè§’åº¦
            const offsetLat = Math.sin(randomAngle) * randomOffset;
            const offsetLon = Math.cos(randomAngle) * randomOffset;
            map.flyTo([targetCity.lat + offsetLat, targetCity.lon + offsetLon], 3, {
                duration: 0.5
            });

            // åœ¨flytoåŠ¨ç”»ç»“æŸåæ˜¾ç¤ºæ ‡è®°
            map.once('moveend', function() {
                showCityMarkers();
            });
        }

        // å¤„ç†åŸå¸‚ç‚¹å‡»
        function handleCityClick(index) {
            if (questionAnswered) {
                // å¦‚æœé—®é¢˜å·²å›ç­”ï¼Œç‚¹å‡»åªä¼šæ˜¾ç¤ºpopup
                cityMarkers[index].openPopup();
                return;
            }

            const clickedCity = cities[index];
            const targetCity = cities[currentCityIndex];

            if (index === currentCityIndex) {
                // ç­”å¯¹äº†
                questionAnswered = true;
                totalQuestions++;
                score++;
                document.getElementById('score').textContent = score;
                document.getElementById('total').textContent = totalQuestions;

                // æ›´æ–°æ ‡è®°æ ·å¼ä¸ºæ­£ç¡®
                const marker = cityMarkers[index];
                const correctIcon = L.divIcon({
                    className: 'city-marker correct-marker',
                    iconSize: [15, 15],
                    iconAnchor: [12.5, 12.5]
                });
                marker.setIcon(correctIcon);

                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                document.getElementById('current-question').innerHTML = 
                    `âœ… æ­£ç¡®ï¼${targetCity.city}ä½äº${targetCity.country}`;

                // å¦‚æœæœ‰infoï¼Œæ˜¾ç¤ºpopup
                if (targetCity.info) {
                    marker.openPopup();
                }

            } else {
                // ç­”é”™äº†
                wrongAttempts++;
                const remainingAttempts = maxWrongAttempts - wrongAttempts;

                // æ›´æ–°é”™è¯¯æ ‡è®°æ ·å¼
                const marker = cityMarkers[index];
                const wrongIcon = L.divIcon({
                    className: 'city-marker wrong-marker',
                    iconSize: [15, 15],
                    iconAnchor: [12.5, 12.5]
                });
                marker.setIcon(wrongIcon);

                // æ˜¾ç¤ºé”™è¯¯æç¤º
                if (remainingAttempts > 0) {
                    document.getElementById('current-question').innerHTML = 
                        `âŒ é”™è¯¯ï¼ä½ ç‚¹å‡»çš„æ˜¯${clickedCity.city}ã€‚è¿˜æœ‰ ${remainingAttempts} æ¬¡æœºä¼š`;
                } else {
                    // æœ€åä¸€æ¬¡ç­”é”™ï¼Œæ˜¾ç¤ºæ­£ç¡®ç­”æ¡ˆ
                    questionAnswered = true;
                    totalQuestions++;
                    document.getElementById('total').textContent = totalQuestions;

                    // æ˜¾ç¤ºæ­£ç¡®ç­”æ¡ˆçš„æ ‡è®°
                    const correctIcon = L.divIcon({
                        className: 'city-marker correct-marker',
                        iconSize: [15, 15],
                        iconAnchor: [12.5, 12.5]
                    });
                    const correctMarkerObj = cityMarkers[currentCityIndex];
                    correctMarkerObj.setIcon(correctIcon);
                    correctMarker = correctMarkerObj;

                    document.getElementById('current-question').innerHTML = 
                        `âŒ é”™è¯¯ï¼ä½ ç‚¹å‡»çš„æ˜¯${clickedCity.city}ï¼Œæ­£ç¡®ç­”æ¡ˆæ˜¯${targetCity.city}`;

                    // å¦‚æœæœ‰infoï¼Œæ˜¾ç¤ºæ­£ç¡®ç­”æ¡ˆçš„popup
                    if (targetCity.info) {
                        correctMarkerObj.openPopup();
                    }
                }
            }
        }

        // æ˜¾ç¤ºç­”æ¡ˆ
        function showAnswer() {
            if (!questionAnswered && currentCityIndex >= 0) {
                questionAnswered = true;
                totalQuestions++;
                document.getElementById('total').textContent = totalQuestions;

                const targetCity = cities[currentCityIndex];

                // æ˜¾ç¤ºæ­£ç¡®ç­”æ¡ˆ
                const correctIcon = L.divIcon({
                    className: 'city-marker correct-marker',
                    iconSize: [15, 15],
                    iconAnchor: [12.5, 12.5]
                });
                const correctMarkerObj = cityMarkers[currentCityIndex];
                correctMarkerObj.setIcon(correctIcon);
                correctMarker = correctMarkerObj;

                document.getElementById('current-question').innerHTML = 
                    `ğŸ’¡ æ­£ç¡®ç­”æ¡ˆæ˜¯${targetCity.city} (${targetCity.country})`;

                // æ˜¾ç¤ºpopupï¼ˆæ— è®ºæ˜¯å¦æœ‰infoï¼‰
                correctMarkerObj.openPopup();
            }
        }

        // ä¸‹ä¸€é¢˜
        function nextQuestion() {
            startNewQuestion();
        }

        // ç»‘å®šæŒ‰é’®äº‹ä»¶
        document.getElementById('next-btn').addEventListener('click', nextQuestion);
        document.getElementById('show-answer-btn').addEventListener('click', showAnswer);

        // åˆå§‹åŒ–
        window.onload = initMap;
    </script>
</body>
</html>
