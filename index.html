<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoGuesser</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        #header {
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
            color: white;
            padding: 12px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            position: relative;
            z-index: 1001;
        }

        #header h1 {
            font-size: 1.4em;
            margin-bottom: 6px;
        }

        #current-question {
            font-size: 1.1em;
            font-weight: bold;
            background: rgba(255, 255, 255, 0.15);
            padding: 6px 16px;
            border-radius: 6px;
            display: inline-block;
            margin-top: 4px;
        }

        #stats {
            margin-top: 6px;
            font-size: 0.85em;
        }

        #map {
            height: calc(100vh - 120px);
            width: 100%;
        }

        #buttons {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            z-index: 1000;
        }

        .btn {
            padding: 12px 30px;
            font-size: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        #next-btn {
            background: linear-gradient(135deg, #4a5568 0%, #718096 100%);
            color: white;
        }

        #show-answer-btn {
            background: linear-gradient(135deg, #4a5568 0%, #718096 100%);
            color: white;
        }

        /* Cheat mode 样式 */
        #cheat-mode-container {
            position: fixed;
            top: 12px;
            right: 12px;
            z-index: 1001;
        }

        #cheat-toggle {
            background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
            color: white;
            padding: 8px 16px;
            font-size: 11px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        #cheat-toggle.active {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }

        #cheat-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            filter: brightness(1.1);
        }

        /* 城市名称标签 */
        .city-label {
            color: black;
            font-size: 13px;
            font-weight: bold;
            white-space: nowrap;
            pointer-events: none;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            filter: brightness(1.1);
        }

        .btn:active {
            transform: translateY(0);
        }

        /* 自定义标记样式 */
        .city-marker {
            background: white;
            border: 3px solid #333;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            /* 移除transition以提高标记跟随地图的响应速度 */
            transition: background-color 0.3s ease, border-color 0.3s ease;
            will-change: transform;
        }

        .city-marker:hover {
            transform: scale(1.3);
            border-color: #667eea;
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.6);
            background-color: white;
        }

        /* 正确答案标记 */
        .correct-marker {
            background: #4CAF50;
            border-color: #2E7D32;
            width: 25px;
            height: 25px;
            animation: pulse 0.5s ease;
            /* 只对颜色属性应用transition */
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        /* 错误答案标记 */
        .wrong-marker {
            background: #f44336;
            border-color: #c62828;
            width: 25px;
            height: 25px;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.5);
            }

            100% {
                transform: scale(1);
            }
        }

        /* Popup样式 */
        .leaflet-popup-content-wrapper {
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .leaflet-popup-content {
            font-size: 14px;
            line-height: 1.6;
            max-width: 300px;
        }

        .info-popup h3 {
            color: #667eea;
            margin-bottom: 8px;
            font-size: 18px;
        }

        .info-popup p {
            color: #555;
            text-align: justify;
        }
    </style>
</head>

<body>
    <div id="header">
        <h1>GeoGuesser</h1>
        <div id="current-question">准备开始...</div>
        <div id="stats">
            得分: <span id="score">0</span> / <span id="total">0</span>
        </div>
    </div>
    <div id="map"></div>
    <div id="cheat-mode-container">
        <button id="cheat-toggle">Cheat Mode</button>
    </div>
    <div id="buttons">
        <button class="btn" id="show-answer-btn">Answer</button>
        <button class="btn" id="next-btn">Next</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="data/baseCountryBoundary.js"></script>
    <script>
        // 全局变量
        let map;
        let cities = [];
        let cityMarkers = {};
        let currentCityIndex = -1;
        let currentQuestionCity = null;
        let score = 0;
        let totalQuestions = 0;
        let questionAnswered = false;
        let wrongAttempts = 0;
        const maxWrongAttempts = 3;
        let historyCities = []; // 记录最近30条历史
        const maxHistorySize = 30;
        let lastQuestionCenter = null; // 记录上一题的中心点
        let countryBoundaryLayer = null; // 当前显示的国家边界图层
        let allCountriesLayer = null; // 所有国家边界图层
        let cityLabelsLayer = null; // 城市名称标签图层
        let cheatMode = false; // 作弊模式开关

        // 初始化地图
        function initMap() {
            map = L.map('map').setView([20, 0], 2);

            // 定义底图
            var CartoDB_VoyagerNoLabels = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 20
            });

            var Esri_OceanBasemap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Ocean/World_Ocean_Base/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Sources: GEBCO, NOAA, CHS, OSU, UNH, CSUMB, National Geographic, DeLorme, NAVTEQ, and Esri',
                maxZoom: 13
            });

            // 添加默认底图
            CartoDB_VoyagerNoLabels.addTo(map);

            // 添加底图切换控件
            var baseMaps = {
                "CartoDB Voyager": CartoDB_VoyagerNoLabels,
                "Ocean Base": Esri_OceanBasemap
            };

            L.control.layers(baseMaps).addTo(map);

            // 加载城市数据
            loadCities();

            // 加载所有国家边界
            loadAllCountries();
        }

        // 加载所有国家边界
        function loadAllCountries() {
            if (typeof countryBoundary !== 'undefined' && countryBoundary) {
                allCountriesLayer = L.geoJSON(countryBoundary, {
                    style: {
                        color: '#000000',
                        weight: 1,
                        fillColor: 'transparent',
                        fillOpacity: 0
                    }
                }).addTo(map);
            }
        }

        // 加载城市数据
        function loadCities() {
            fetch('data/cities.json')
                .then(response => response.json())
                .then(data => {
                    cities = data;
                    addCityMarkers();
                    showCityMarkers();
                    startNewQuestion();
                })
                .catch(error => {
                    console.error('加载城市数据失败:', error);
                    document.getElementById('current-question').textContent = '加载城市数据失败';
                });
        }

        // 添加所有城市标记
        function addCityMarkers() {
            cities.forEach((city, index) => {
                const icon = L.divIcon({
                    className: 'city-marker',
                    iconSize: [15, 15],
                    iconAnchor: [10, 10]
                });

                const marker = L.marker([city.lon, city.lat], {icon: icon})
                    .on('click', function () {
                        handleCityClick(index);
                    });

                // 如果有info信息，添加popup
                if (city.info) {
                    marker.bindPopup(`
                        <div class="info-popup">
                            <h3>${city.city}</h3>
                            <p>${city.info}</p>
                        </div>
                    `, {
                        maxWidth: 350
                    });
                } else {
                    marker.bindPopup(`
                        <div class="info-popup">
                            <h3>${city.city}</h3>
                            <p>位于${city.country}</p>
                        </div>
                    `, {
                        maxWidth: 350
                    });
                }

                cityMarkers[index] = marker;
            });
        }

        // 显示所有城市标记
        function showCityMarkers() {
            cities.forEach((city, index) => {
                if (cityMarkers[index] && !map.hasLayer(cityMarkers[index])) {
                    cityMarkers[index].addTo(map);
                }
            });
        }

        // 开始新问题
        function startNewQuestion() {
            // 重置状态
            questionAnswered = false;
            wrongAttempts = 0;

            // 清除上一题的国家边界
            if (countryBoundaryLayer) {
                map.removeLayer(countryBoundaryLayer);
                countryBoundaryLayer = null;
            }

            // 先隐藏所有标记
            cities.forEach((city, index) => {
                if (cityMarkers[index] && map.hasLayer(cityMarkers[index])) {
                    map.removeLayer(cityMarkers[index]);
                }
                // 重置标记样式
                const icon = L.divIcon({
                    className: 'city-marker',
                    iconSize: [15, 15],
                    iconAnchor: [10, 10]
                });
                cityMarkers[index].setIcon(icon);
            });

            // 随机选择一个不在历史记录中的城市
            let availableCities = cities.map((city, index) => index)
                .filter(index => !historyCities.includes(index));

            // 如果可用城市少于总城市的30%，清空历史记录
            if (availableCities.length < cities.length * 0.3) {
                historyCities = [];
                availableCities = cities.map((city, index) => index);
            }

            const randomIndex = Math.floor(Math.random() * availableCities.length);
            currentCityIndex = availableCities[randomIndex];
            currentQuestionCity = cities[currentCityIndex];

            // 显示问题
            document.getElementById('current-question').textContent =
                `请在地图上找到: ${currentQuestionCity.country} ${currentQuestionCity.city}`;

            // 将地图视图移动到该城市附近（但不显示标记）
            const targetCity = cities[currentCityIndex];
            // 获取当前zoom level，不改变zoom
            const currentZoom = map.getZoom();
            // 添加随机偏移量，防止直接猜到
            const randomOffset = 5 + Math.random() * 5; // 5-10度的随机偏移
            const randomAngle = Math.random() * Math.PI * 2; // 随机角度
            const offsetLat = Math.sin(randomAngle) * randomOffset;
            const offsetLon = Math.cos(randomAngle) * randomOffset;
            const newCenter = [targetCity.lon + offsetLon,targetCity.lat + offsetLat];

            // 距离检测函数：计算两点之间的球面距离（单位：公里）
            function calculateDistance(lat1, lon1, lat2, lon2) {
                const R = 6371; // 地球半径，单位公里
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLon = (lon2 - lon1) * Math.PI / 180;
                const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon / 2) * Math.sin(dLon / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                return R * c;
            }

            // 检查是否需要飞到新位置
            let shouldFlyTo = true;
            if (lastQuestionCenter) {
                const distance = calculateDistance(
                    lastQuestionCenter[0], lastQuestionCenter[1],
                    newCenter[0], newCenter[1]
                );
                if (distance <= 2000) {
                    shouldFlyTo = false;
                }
            }

            if (shouldFlyTo) {
                map.flyTo(newCenter, currentZoom, {
                    duration: 0.5
                });
                lastQuestionCenter = newCenter;
            } else {
                // 不需要飞的时候，直接显示标记
                showCityMarkers();
            }

            // 如果需要飞，在flyto动画结束后显示标记
            if (shouldFlyTo) {
                map.once('moveend', function () {
                    showCityMarkers();
                });
            }
        }

        // 处理城市点击
        function handleCityClick(index) {
            const clickedCity = cities[index];
            const targetCity = cities[currentCityIndex];

            // 如果问题已回答,点击任何标记都只显示popup
            if (questionAnswered) {
                // 确保marker在地图上
                if (!map.hasLayer(cityMarkers[index])) {
                    cityMarkers[index].addTo(map);
                }

                // 重新绑定并打开popup
                const marker = cityMarkers[index];
                const popupContent = clickedCity.info ?
                    `<div class="info-popup"><h3>${clickedCity.city}</h3><p>${clickedCity.info}</p></div>` :
                    `<div class="info-popup"><h3>${clickedCity.city}</h3><p>位于${clickedCity.country}</p></div>`;

                const popup = L.popup({
                    maxWidth: 350,
                    autoPan: true,
                    closeButton: true,
                    closeOnClick: false
                }).setLatLng([clickedCity.lon, clickedCity.lat]).setContent(popupContent);

                map.openPopup(popup);
                return;
            }

            if (index === currentCityIndex) {
                // 答对了
                questionAnswered = true;
                totalQuestions++;
                score++;
                document.getElementById('score').textContent = score;
                document.getElementById('total').textContent = totalQuestions;

                // 记录到历史
                historyCities.push(currentCityIndex);
                if (historyCities.length > maxHistorySize) {
                    historyCities.shift();
                }

                // 更新标记样式为正确
                const marker = cityMarkers[index];
                const correctIcon = L.divIcon({
                    className: 'city-marker correct-marker',
                    iconSize: [15, 15],
                    iconAnchor: [12.5, 12.5]
                });
                marker.setIcon(correctIcon);

                // 显示成功消息
                document.getElementById('current-question').innerHTML =
                    `Correct！${targetCity.country} ${targetCity.city} 位置正确`;

                // 显示国家边界
                showCountryBoundary(targetCity.country);

                // 使用独立popup显示
                const popupContent = targetCity.info ?
                    `<div class="info-popup"><h3>${targetCity.city}</h3><p>${targetCity.info}</p></div>` :
                    `<div class="info-popup"><h3>${targetCity.city}</h3><p>位于${targetCity.country}</p></div>`;

                const popup = L.popup({
                    maxWidth: 350,
                    autoPan: true,
                    closeButton: true,
                    closeOnClick: false
                }).setLatLng([targetCity.lon, targetCity.lat]).setContent(popupContent);

                map.openPopup(popup);

            } else {
                // 答错了
                wrongAttempts++;
                const remainingAttempts = maxWrongAttempts - wrongAttempts;

                // 更新错误标记样式
                const marker = cityMarkers[index];
                const wrongIcon = L.divIcon({
                    className: 'city-marker wrong-marker',
                    iconSize: [15, 15],
                    iconAnchor: [12.5, 12.5]
                });
                marker.setIcon(wrongIcon);

                // 显示错误提示
                if (remainingAttempts > 0) {
                    document.getElementById('current-question').innerHTML =
                        `Wrong! 你点击的是${clickedCity.city}，要找的是${targetCity.country}的${targetCity.city}。还有 ${remainingAttempts} 次机会`;
                } else {
                    // 最后一次答错，显示正确答案
                    questionAnswered = true;
                    totalQuestions++;
                    document.getElementById('total').textContent = totalQuestions;

                    // 记录到历史
                    historyCities.push(currentCityIndex);
                    if (historyCities.length > maxHistorySize) {
                        historyCities.shift();
                    }

                    // 显示正确答案的标记
                    const correctIcon = L.divIcon({
                        className: 'city-marker correct-marker',
                        iconSize: [15, 15],
                        iconAnchor: [12.5, 12.5]
                    });
                    const correctMarkerObj = cityMarkers[currentCityIndex];
                    correctMarkerObj.setIcon(correctIcon);

                    document.getElementById('current-question').innerHTML =
                        `Wrong! 你点击的是${clickedCity.city}，正确答案是${targetCity.city}`;

                    // 使用独立popup显示正确答案
                    const popupContent = targetCity.info ?
                        `<div class="info-popup"><h3>${targetCity.city}</h3><p>${targetCity.info}</p></div>` :
                        `<div class="info-popup"><h3>${targetCity.city}</h3><p>位于${targetCity.country}</p></div>`;

                    const popup = L.popup({
                        maxWidth: 350,
                        autoPan: true,
                        closeButton: true,
                        closeOnClick: false
                    }).setLatLng([targetCity.lon, targetCity.lat]).setContent(popupContent);

                    map.openPopup(popup);

                    // 显示国家边界
                    showCountryBoundary(targetCity.country);
                }
            }
        }

        // 显示答案
        function showAnswer() {
            if (!questionAnswered && currentCityIndex >= 0) {
                questionAnswered = true;
                totalQuestions++;
                document.getElementById('total').textContent = totalQuestions;

                // 记录到历史
                historyCities.push(currentCityIndex);
                if (historyCities.length > maxHistorySize) {
                    historyCities.shift();
                }

                const targetCity = cities[currentCityIndex];

                // 显示正确答案
                const correctIcon = L.divIcon({
                    className: 'city-marker correct-marker',
                    iconSize: [15, 15],
                    iconAnchor: [12.5, 12.5]
                });
                const correctMarkerObj = cityMarkers[currentCityIndex];
                correctMarkerObj.setIcon(correctIcon);

                document.getElementById('current-question').innerHTML =
                    `正确答案是${targetCity.city} (${targetCity.country})`;

                // 使用独立popup显示
                const popupContent = targetCity.info ?
                    `<div class="info-popup"><h3>${targetCity.city}</h3><p>${targetCity.info}</p></div>` :
                    `<div class="info-popup"><h3>${targetCity.city}</h3><p>位于${targetCity.country}</p></div>`;

                const popup = L.popup({
                    maxWidth: 350,
                    autoPan: true,
                    closeButton: true,
                    closeOnClick: false
                }).setLatLng([targetCity.lon, targetCity.lat]).setContent(popupContent);

                map.openPopup(popup);

                // 显示国家边界
                showCountryBoundary(targetCity.country);
            }
        }

        // 显示国家边界
        function showCountryBoundary(countryName) {
            // 清除之前的国家边界高亮
            if (countryBoundaryLayer) {
                map.removeLayer(countryBoundaryLayer);
            }

            // 尝试从countryBoundary中找到匹配的国家
            if (typeof countryBoundary !== 'undefined' && countryBoundary) {
                const matchedFeature = countryBoundary.features.find(feature =>
                    feature.properties && feature.properties.NAME_ZH === countryName
                );

                if (matchedFeature) {
                    // 在所有国家边界之上显示高亮的国家
                    countryBoundaryLayer = L.geoJSON(matchedFeature, {
                        style: {
                            color: '#4a5568',
                            weight: 3,
                            fillColor: '#4a5568',
                            fillOpacity: 0.3
                        }
                    }).addTo(map);
                }
            }
        }

        // 下一题
        function nextQuestion() {
            startNewQuestion();
        }

        // 切换作弊模式
        function toggleCheatMode() {
            cheatMode = !cheatMode;
            const toggleBtn = document.getElementById('cheat-toggle');

            if (cheatMode) {
                toggleBtn.textContent = 'Cheat Mode: ON';
                toggleBtn.classList.add('active');
                showCityLabels();
            } else {
                toggleBtn.textContent = 'Cheat Mode';
                toggleBtn.classList.remove('active');
                hideCityLabels();
            }
        }

        // 显示城市名称标签
        function showCityLabels() {
            if (cityLabelsLayer) {
                map.removeLayer(cityLabelsLayer);
            }

            const markers = cities.map(city => {
                const icon = L.divIcon({
                    className: 'city-label',
                    html: city.city,
                    iconSize: null,
                    iconAnchor: [0, 0]
                });
                return L.marker([city.lon, city.lat], { icon: icon, interactive: false });
            });

            cityLabelsLayer = L.layerGroup(markers).addTo(map);
        }

        // 隐藏城市名称标签
        function hideCityLabels() {
            if (cityLabelsLayer) {
                map.removeLayer(cityLabelsLayer);
                cityLabelsLayer = null;
            }
        }

        // 绑定按钮事件
        document.getElementById('next-btn').addEventListener('click', nextQuestion);
        document.getElementById('show-answer-btn').addEventListener('click', showAnswer);
        document.getElementById('cheat-toggle').addEventListener('click', toggleCheatMode);

        // 初始化
        window.onload = initMap;
    </script>
</body>

</html>